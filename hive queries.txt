# Download the dataset
wget https://www.dropbox.com/s/nmz1zd2bw2n5ora/nyc_311_sample.csv

# Run the Python data cleaning script
python3 /home/cloudera/scripts/data_cleaning.py

# Create a directory in Hadoop for storing the data
hadoop fs -mkdir /BigData/hive/nyc_311_data;

# Upload the cleaned dataset to Hadoop
hadoop fs -copyFromLocal /home/cloudera/nyc_311/modified_nyc_311_sample.csv /BigData/hive/nyc_311_data/.;

# Hive table creation
CREATE EXTERNAL TABLE IF NOT EXISTS nycData_abdulhaseeb (
  `Unique Key` INT,
  `Created Date` TIMESTAMP,
  `Closed Date` TIMESTAMP,
  `Agency` STRING,
  `Agency Name` STRING,
  `Complaint Type` STRING,
  `Descriptor` STRING,
  `Location Type` STRING,
  `Incident Zip` INT,
  `Incident Address` STRING,
  `Street Name` STRING,
  `Cross Street 1` STRING,
  `Cross Street 2` STRING,
  `Intersection Street 1` STRING,
  `Intersection Street 2` STRING,
  `Address Type` STRING,
  `City` STRING,
  `Landmark` STRING,
  `Facility Type` STRING,
  `Status` STRING,
  `Due Date` TIMESTAMP,
  `Resolution Description` STRING,
  `Resolution Action Updated Date` TIMESTAMP,
  `Community Board` STRING,
  `BBL` STRING,
  `Borough` STRING,
  `X Coordinate (State Plane)` DOUBLE,
  `Y Coordinate (State Plane)` DOUBLE,
  `Open Data Channel Type` STRING,
  `Park Facility Name` STRING,
  `Park Borough` STRING,
  `Vehicle Type` STRING,
  `Taxi Company Borough` STRING,
  `Taxi Pick Up Location` STRING,
  `Bridge Highway Name` STRING,
  `Bridge Highway Direction` STRING,
  `Road Ramp` STRING,
  `Bridge Highway Segment` STRING,
  `Latitude` DOUBLE,
  `Longitude` DOUBLE,
  `Location` STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION '/BigData/hive/nyc_311_data/'
TBLPROPERTIES('skip.header.line.count'='1');

# Sample Queries
# Query 1: Top 10 complaint types
SELECT UPPER(`Complaint Type`), COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
GROUP BY UPPER(`Complaint Type`)
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 2: Top 10 complaint types for the year 2022
SELECT UPPER(`Complaint Type`), COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE substr(`Created Date`, 1, 4) = '2022'
GROUP BY UPPER(`Complaint Type`)
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 3: Top 10 cities with most complaints
SELECT UPPER(`City`) AS UnifiedCity, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE `City` != ' ' AND `City` != ''
GROUP BY UPPER(`City`)
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 4: Top 10 streets with the most incidents in Brooklyn
SELECT `Incident Address`, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE `City` = 'BROOKLYN' AND `Incident Address` IS NOT NULL AND trim(`Incident Address`) != ''
GROUP BY `Incident Address`
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 5: Top 10 streets with the most incidents in Bronx
SELECT `Incident Address`, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE `City` = 'BRONX' AND `Incident Address` IS NOT NULL AND trim(`Incident Address`) != ''
GROUP BY `Incident Address`
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 6: Facility types with most complaints
SELECT `Facility Type`, COUNT(*) AS TotalComplaints,
       ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS PercentOfTotal
FROM nycData_abdulhaseeb
WHERE `Facility Type` != 'N/A' AND `Facility Type` != '' AND `Facility Type` != ' '
GROUP BY `Facility Type`
ORDER BY PercentOfTotal DESC
LIMIT 4;

# Query 7: Top 10 Agencies which received most complaints in 2022
SELECT `Agency Name`, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE substr(`Created Date`, 1, 4) = '2022'
GROUP BY `Agency Name`
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 8: Top 10 Agencies which received most complaints (overall)
SELECT `Agency Name`, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
GROUP BY `Agency Name`
ORDER BY ComplaintCount DESC
LIMIT 10;

# Query 9: Agencies with the most open complaints up to 2018
SELECT UPPER(`Agency Name`) AS AgencyName, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE CAST(substr(`Created Date`, 1, 4) AS INT) <= 2018
  AND UPPER(`Status`) NOT IN ('CLOSED', 'CLOSED - TESTING', 'STARTED', 'UNSPECIFIED')
GROUP BY UPPER(`Agency Name`)
ORDER BY ComplaintCount DESC
LIMIT 5;

# Query 10: Top 5 Location types with most complaints
SELECT `Location type`, COUNT(*) AS ComplaintCount
FROM nycData_abdulhaseeb
WHERE TRIM(`Location type`) != ''
GROUP BY `Location type`
ORDER BY ComplaintCount DESC
LIMIT 5;
